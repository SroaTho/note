# STP

STP可以将有环路的物理拓扑变成无环路的逻辑拓扑，以避免环路产生或链路断开。

STP使网络中的计算机在通讯时只有一条链路，当链路出现故障时，重新计算出新的最优链路，从而保证网络连接稳定可靠。



## 简单术语

1. **桥**：泛指具有任意多个端口的交换机。
2. **桥的MAC地址**：一台交换机有多个端口，每个端口都有一个MAC地址。
3. **桥ID（BID）**：由两部分组成，前两个字节为这个桥设置的优先级，后面6个字节是这个桥的MAC地址。
4. **端口ID（PID）**：具有多种组成方式，常见的方式为以下两种：
    1. **第一种**：端口ID由2字节组成，**字节1**是该端口ID的**优先级**，**字节2**是该端口的**端口号**。
    2. **第二种**：端口ID由2字节（16位）组成，**前4位**是该端口的端口**优先级**，**后12位**是该端口的**端口号**。
5. **根路径开销（RPC）**：某个**交换机（某个端口）到根桥的累积路径开销**。即从该端口到根桥所经过的所有链路的路径开销总和。
6. **根桥**：整个交换网络的逻辑中心（不一定是物理中心）

6. **根端口**：非根桥可能由多个端口与根桥通信，非根桥到根桥通信最优的端口（根端口）。

7. **指定端口**：向下层交换机转发数据的端口。

8. **阻塞端口**：被阻塞用于备用的端口，该端口**不转发数据帧**（不接受、不发送），但可以**接收并处理STP帧**（仅接受，不发送）。



注：根端口和指定端口转发数据帧（接收和发送），阻塞端口不转发数据帧（不接收，不发送）。



## 生成树



### 1. 根桥选举

STP启动后，所有交换机会认为自己是根桥，并在发送给其他交换机的BPDU中宣告自己是根桥。

当交换机从网络中收到其他设备发送过来的BPDU的时候，会比较新的BPDU中的根桥BID和自己的BID，较小的BID将作为根桥。交换机会将新的BPDU的时候，会宣告新的根桥。

交换机会互相交换BPDU，最后BID最小的根桥会成为根桥。



### 2. 根端口选举

根端口是非根桥（交换机）某个端口到根桥（交换机）通信的最优端口。即从该端口到根桥的路径开销总和最小的端口。

根桥没有根端口，根桥的所有端口均为指定端口。

非根桥会选举唯一一个根端口，到根桥路径开销总和最小的端口。



### 3. 其他端口

根桥交换机只有指定端口，不会有除了指定端口以外的其他任何端口。



在**非根桥**的交换机中，除了根端口以外的端口，可称之为其他端口或非根端口。

其他端口分为：指定端口和阻塞端口。

在生成树协议（STP）中，非根桥的其他端口通过**比较收到的RPC**和**自身该端口的RPC**来确定（是指定端口，还是阻塞端口）。

**指定端口**：**（非根桥）其他端口**收到BPDU中的**RPC大于自身该端口的RPC**，则该端口为**指定端口**。

**阻塞端口**：**（非根桥）其他端口**收到BPDU中的**RPC小于自身该端口的RPC**，则该端口为**阻塞端口**。



