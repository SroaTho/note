# NAT简介

网络地址转换NAT（Network Address Translation）是将IP数据报文头中的IP地址转换为另一个IP地址的过程。

当内网的主机要访问外网时，通过NAT技术可以将其私网地址转换为公网地址，可以实现多个私网用户共用一个公网地址来访问外部网络，这样既可保证网络互通，又节省了公网地址。



## Basic NAT

Basic NAT方式属于一对一的地址转换，在这种方式下只转换IP地址，而不处理TCP/UDP协议的端口号，一个公网IP地址不能同时被多个私网用户使用。

![img](./images/%E3%80%90NAT%E3%80%91%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2.assets/fig_dc_fd_NAT_000402.png)

1. Router收到内网侧Host发送的访问公网侧Server的报文，其源IP地址为10.1.1.100。
2. Router从地址池中选取一个空闲的公网IP地址，建立与内网侧报文源IP地址间的NAT转换表项（正反向），并依据查找正向NAT表项的结果将报文转换后向公网侧发送，其源IP地址是1.1.1.1，目的IP地址是2.2.2.2。
3. Router收到公网侧的回应报文后，根据其目的IP地址查找反向NAT表项，并依据查表结果将报文转换后向私网侧发送，其源IP地址是2.2.2.2，目的IP地址是10.1.1.100。



## NAPT

除了一对一的NAT转换方式外，网络地址端口转换NAPT（Network Address Port Translation）可以实现并发的地址转换。它允许多个内部地址映射到同一个公有地址上，因此也可以称为“多对一地址转换”或地址复用。

NAPT方式属于多对一的地址转换，它通过使用“IP地址＋端口号”的形式进行转换，使多个私网用户可共用一个公网IP地址访问外网。

![img](./images/%E3%80%90NAT%E3%80%91%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2.assets/fig_dc_fd_NAT_000401.png)

1. Router收到内网侧Host发送的访问公网侧Server的报文。比如收到Host A报文的源地址是10.1.1.100，端口号1025。
2. Router从地址池中选取一对空闲的“公网IP地址＋端口号”，建立与内网侧报文“源IP地址＋源端口号”间的NAPT转换表项（正反向），并依据查找正向NAPT表项的结果将报文转换后向公网侧发送。比如Host A的报文经Router转换后的报文源地址为1.1.1.1，端口号16384。
3. Router收到公网侧的回应报文后，根据其“目的IP地址＋目的端口号”查找反向NAPT表项，并依据查表结果将报文转换后向私网侧发送。比如Server回应Host A的报文经Router转换后，目的地址为10.1.1.100，端口号1025。



## NAT Server

NAT具有“屏蔽”内部主机的作用，但有时内网需要向外网提供服务，比如提供WWW服务或者FTP服务。这种情况下需要内网的服务器不被“屏蔽”，外网用户可以随时访问内网服务器。

NAT Server可以很好地解决这个问题，当外网用户访问内网服务器时，它通过事先配置好的“公网IP地址+端口号”与“私网IP地址+端口号”间的映射关系，将服务器的“公网IP地址+端口号”根据映射关系替换成对应的“私网IP地址+端口号”。

![img](./images/%E3%80%90NAT%E3%80%91%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2.assets/fig_dc_fd_NAT_000502.png)

1. 在Router上配置NAT Server的转换表项。
2. Router收到公网用户发起的访问请求，设备根据该请求的“目的IP+端口号”查找NAT Server转换表项，找出对应的“私网IP+端口号”，然后用查找结果替换报文的“目的IP+端口号”。
3. Router收到内网服务器的回应报文后，根据该回应报文的“源IP地址＋源端口号”查找NAT Server转换表项，找出对应的“公网IP+端口号”，然后用查找结果替换报文的“源IP地址＋源端口号”。



## Easy IP

Easy IP方式可以利用访问控制列表来控制哪些内部地址可以进行地址转换。

Easy IP方式特别适合小型局域网访问Internet的情况。这里的小型局域网主要指中小型网吧、小型办公室等环境，一般具有以下特点：内部主机较少、出接口通过拨号方式获得临时公网IP地址以供内部主机访问Internet。对于这种情况，可以使用Easy IP方式使局域网用户都通过这个IP地址接入Internet。

![img](./images/%E3%80%90NAT%E3%80%91%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2.assets/fig_dc_fd_NAT_000501.png)

1. Router收到内网侧主机发送的访问公网侧服务器的报文。
2. Router利用公网侧接口的“公网IP地址＋端口号”，建立与内网侧报文“源IP地址＋源端口号”间的Easy IP转换表项（正反向），并依据查找正向Easy IP表项的结果将报文转换后向公网侧发送。
3. Router收到公网侧的回应报文后，根据其“目的IP地址＋目的端口号”查找反向Easy IP表项，并依据查表结果将报文转换后向内网侧发送。



## NAT ALG

NAT和NAPT只能对IP报文的头部地址和TCP/UDP头部的端口信息进行转换。

ALG是对特定的应用层协议进行转换，在对这些特定的应用层协议进行NAT转换过程中，通过NAT的状态信息来改变封装在IP报文数据部分中的特定数据，最终使应用层协议可以跨越不同范围运行。



例如，一个使用内部IP地址的FTP服务器可能在和外部网络主机建立会话的过程中需要将自己的IP地址发送给对方。而这个地址信息是放到IP报文的数据部分，NAT无法对它进行转换。当外部网络主机接收了这个私有地址并使用它，这时FTP服务器将表现为不可达。

目前支持ALG功能的协议包括：DNS、FTP、SIP、PPTP和RTSP。

| 应用协议 | 做NAT变换的字段                                              |
| -------- | ------------------------------------------------------------ |
| DNS      | 响应报文中的IP和Port                                         |
| FTP      | Port请求报文中载荷里的IP和PortPassive响应报文中载荷里的IP和Port |
| SIP      | Request lineFromToContactViaOMessage body的C字段地址和M字段的端口record-router |
| PPTP     | 分PPTP Client在私网还是PPTP Server在私网两种场景：PPTP Client在私网，PPTP Server在公网时，仅对Client-Call-ID进行端口替换PPTP Server在私网，PPTP Client在公网时，仅对Server-Call-ID进行端口替换 |
| RTSP     | setup/reply OK报文中的端口字段                               |



# NAT other

## DNS Mapping

在某些应用中，私网用户希望通过域名访问位于同一私网的内部服务器，由于通常DNS响应报文中携带的是内部服务器的公网IP地址，因此若NAT设备未将DNS Server解析的公网IP替换成内部服务器对应的私网IP，私网用户将无法通过域名访问到内部服务器。

这个问题可以使用DNS Mapping方式来解决，通过配置“域名—公网IP地址—公网端口—协议类型”映射表，建立内部服务器的域名与其公网信息间的对应关系。



![img](./images/%E3%80%90NAT%E3%80%91%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2.assets/fig_dc_fd_NAT_000701.png)

私网用户Host希望通过域名方式访问Web Server，Router作为NAT服务器。

1. 当Router设备收到DNS响应报文后，先根据其中携带的域名查找DNS Mapping映射表，再根据“公网IP地址—公网端口—协议类型”查找Web Server
2. 将DNS响应报文中的公网IP地址替换成Web Server的私网IP地址。
3. Host收到的DNS响应报文中就携带了Web Server的私网IP地址，从而可以通过域名来访问Web Server。



## NAT过滤

NAT过滤是指NAT设备对外网发到内网的流量进行过滤，包括三种类型：

- **与外部地址无关的NAT过滤行为**

这种类型的过滤行为不考虑数据包的源IP地址，而是基于其他因素（例如目的IP地址、目的端口号等）来决定是否允许数据包进入内部网络。

- **与外部地址相关的NAT过滤行为**

主要用于控制对特定内部主机或服务的访问，而不关心请求来自哪个外部源。例如，你可以允许所有外部来源的HTTP（端口80）或HTTPS（端口443）请求到达内部的Web服务器。

- **与外部地址和端口都相关的NAT过滤行为**

当内部网络的服务需要对所有外部用户开放，而不需要限制源地址时使用。



![img](./images/%E3%80%90NAT%E3%80%91%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2.assets/fig_dc_fd_NAT_001001.png)

当私网主机PC-1向公网主机PC-2发起通信，发送数据包时，其源IP及端口信息为10.1.1.1:1111（经NAT转换后为3.3.3.3:1111），而目的IP及端口信息设定为2.2.2.2:2222。

**与外部地址无关的NAT过滤行为**

- **定义**：在该模式下，NAT设备对源IP地址不做检查，仅验证数据包的目的IP和端口是否为3.3.3.3:1111。

    **操作**：允许任何源IP地址向3.3.3.3:1111发送数据包，无需关注其具体来源。

**与外部地址相关的NAT过滤行为**

- **定义**：此模式下，NAT设备会对源IP地址进行检查，确保其与先前建立的连接（如PC-2的IP地址1.1.1.1）一致，但不对源端口做特定限制，目标IP和端口依然需为3.3.3.3:1111。

    **操作**：仅当源IP地址为1.1.1.1时，允许从任意源端口向3.3.3.3:1111发送数据包。

**与外部地址和端口都相关的NAT过滤行为**

- **定义**：这是一种最严格的过滤模式，不仅检查源IP地址是否为特定值（如PC-2的IP地址1.1.1.1），还检查源端口是否为指定值（如2222），目标IP和端口保持为3.3.3.3:1111。

    **操作**：仅当源IP地址和端口完全匹配1.1.1.1:2222时，允许数据包通过，目的地依然限定为3.3.3.3:1111。



## NAT映射

在Internet中使用NAT映射功能，所有不同的信息流看起来好像来源于同一个IP地址。

因为NAT映射使得一组主机可以共享唯一的外部地址，当位于内部网络中的主机通过NAT设备向外部主机发起会话请求时，NAT设备就会查询NAT表，看是否有相关会话记录，如果有相关记录，就会将内部IP地址及端口同时进行转换，再转发出去；如果没有相关记录，进行IP地址和端口转换的同时，还会在NAT表增加一条该会话的记录。

NAT映射是NAT设备对内网发到外网的流量进行映射，包括以下两种类型：

- **外部地址无关的映射**：对相同的内部IP和端口重用相同的地址端口映射。

- **外部地址和端口相关的映射**：对相同的内部IP地址和端口号访问相同的外部IP地址和端口号重用相同的端口映射（如果此映射条目还处在活动状态）。

 

**示例：**

网络中有三台电脑A、B和C，它们都有自己的内部IP地址（例如，192.168.1.2, 192.168.1.3, 和 192.168.1.4），但共享一个公共的外部IP地址（比如，123.45.67.89）来访问互联网。

**外部地址无关的映射**

- **情况1**：电脑A尝试访问Google（外部IP：35.204.210.113），NAT设备为电脑A的请求分配了一个外部端口（比如，50000），并将这个映射（192.168.1.2:任意端口 -> 123.45.67.89:50000）保存下来。
- **情况2**：接着，电脑A又尝试访问Facebook（外部IP：69.63.176.133），由于是同一台电脑A发出的请求，NAT设备会再次使用之前保存的映射（192.168.1.2:任意端口 -> 123.45.67.89:50000），即使目标外部IP不同。

**外部地址和端口相关的映射**

- **情况1**：电脑A访问Google（35.204.210.113），NAT设备创建一个映射（192.168.1.2:任意端口 -> 123.45.67.89:50000）。
- **情况2**：电脑A接着访问Facebook（69.63.176.133），尽管是同一台电脑A，但由于目标外部IP不同，NAT设备会创建一个新的映射（192.168.1.2:任意端口 -> 123.45.67.89:另一个端口，比如50001）。
- **情况3**：如果电脑A再次访问Google（35.204.210.113），并且之前的映射（192.168.1.2:任意端口 -> 123.45.67.89:50000）仍然有效，那么NAT设备会重用这个映射，而不是创建一个新的。

