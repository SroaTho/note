# ACL访问控制列表

## ACL的组成

![img](./images/%E3%80%90ACL%E3%80%91%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E5%88%97%E8%A1%A8.assets/fig_dc_cfg_acl_100401-1717587176375-1.png)

- **ACL名称**：通过名称来标识ACL，就像用域名代替IP地址一样，更加方便记忆。这种ACL，称为命名型ACL。

    命名型ACL一旦创建成功，便不允许用户再修改其名称。

    仅基本ACL与基本ACL6，以及高级ACL与高级ACL6，可以使用相同的ACL名称；其他类型ACL之间，不能使用相同的ACL名称。

    命名型ACL实际上是“名字+数字”的形式，可以在定义命名型ACL时同时指定ACL编号。如果不指定编号，则由系统自动分配，设备为其分配的编号是该类型ACL可用编号中取值范围内的最大值。

- **ACL编号**：用于标识ACL，也可以单独使用ACL编号，表明该ACL是数字型。

    不同的ACL类型使用不同的ACL编号取值标识。

- **规则**：即描述报文匹配条件的判断语句。

    - **规则编号**：用于标识ACL规则。可以自行配置规则编号，也可以由系统自动分配。

        ACL规则的编号范围是0～4294967294，所有规则均按照规则编号从小到大进行排序。系统按照规则编号从小到大的顺序，将规则依次与报文匹配，一旦匹配上一条规则即停止匹配。

    - **动作**：报文处理动作，包括permit/deny两种，表示允许/拒绝。

    - **匹配项**：ACL定义了极其丰富的匹配项。除了图1中的源地址和生效时间段，ACL还支持很多其他规则匹配项。例如，二层以太网帧头信息（如源MAC、目的MAC、以太帧协议类型），三层报文信息（如目的IP地址、协议类型），以及四层报文信息（如TCP/UDP端口号）等。关于每种匹配项的详细介绍，请参见交换机支持的ACL及常用匹配项。



## ACL的实现方式

目前设备支持的ACL，有以下两种实现方式。

- 软件ACL：针对与本机交互的报文（必须上送CPU处理的报文），由软件实现来过滤报文的ACL，比如FTP、TFTP、Telnet、SNMP、HTTP、路由协议、组播协议中引用的ACL。
- 硬件ACL：针对所有报文，通过下发ACL资源到硬件来过滤报文的ACL，比如流策略、基于ACL的简化流策略、用户组以及为接口收到的报文添加外层Tag功能中引用的ACL。



两者主要区别在于：

- 过滤的报文类型不同：软件ACL用来过滤与本机交互的报文，硬件ACL可以用来过滤所有报文。
- 报文过滤方式不同：软件ACL是被上层软件引用来实现报文的过滤，硬件ACL是被下发到硬件来实现报文的过滤。通过软件ACL过滤报文时，会消耗CPU资源，通过硬件ACL过滤报文时，则会占用硬件资源。通过硬件ACL过滤报文的速度更快。
- 对不匹配ACL的报文的处理动作不同：当使用软件ACL时，如果报文未匹配上ACL中的规则，设备对该报文采取的动作为deny，即拒绝报文通过；当使用硬件ACL时，如果报文未匹配上ACL中的规则，设备对该报文采取的动作为permit，即允许报文通过。



## 交换机支持的ACL

| 分类          | 适用的IP版本 | 规则定义描述                                                 | 编号范围   |
| ------------- | ------------ | ------------------------------------------------------------ | ---------- |
| 基本ACL       | IPv4         | IPV4报文的**源IP地址**、**分片信息**和**生效时间段**信息来定义规则。 | 2000～2999 |
| 高级ACL       | IPv4         | IPV4报文的**源IP地址**、**目的IP地址**、**IP协议类型**、**ICMP类型**、**TCP源/目的端口**、**UDP源/目的端口号**、**生效时间段**等来定义规则。 | 3000～3999 |
| 二层ACL       | IPv4和IPv6   | 报文的**以太网帧头信息**来定义规则，根据**源MAC地址**、**目的MAC地址**、**二层协议类型**等。 | 4000～4999 |
| 用户自定义ACL | IPv4和IPv6   | 使用**报文头、偏移位置、字符串掩码和用户自定义字符串**来定义规则，即以报文头为基准，指定从报文的第几个字节开始与字符串掩码进行“与”操作，并将提取出的字符串与用户自定义的字符串进行比较，从而过滤出相匹配的报文。 | 5000～5999 |
| 用户ACL       | IPv4         | IPv4报文的**源IP地址或源UCL（User Control List）组**、**目的IP地址或目的UCL组**、IP协议类型、ICMP类型、TCP源端口/目的端口、UDP源端口/目的端口号等来定义规则。 | 6000～9999 |
| 基本ACL6      | IPv6         | IPv6报文的**源IPv6地址**、**分片信息**和**生效时间段**来定义规则。 | 2000～2999 |
| 高级ACL6      | IPv6         | IPv6报文的**源IPv6地址**、**目的IPv6地址**、IPv6协议类型、ICMPv6类型、TCP源/目的端口、UDP源/目的端口号、生效时间段等来定义规则。 | 3000～3999 |
| 用户ACL6      | IPv6         | IPv6报文的**源IPv6地址或源UCL组**、**目的IPv6地址**、IPv6协议类型、ICMPv6类型、TCP源端口/目的端口、UDP源端口/目的端口号等来定义规则。 | 6000～9999 |



### 生效时间段

在ACL规则中引用的生效时间段存在两种模式：

- 第一种模式——周期时间段：以星期为参数来定义时间范围，表示规则以一周为周期（如每周一的8至12点）循环生效。
- 第二种模式——绝对时间段：从某年某月某日的某一时间开始，到某年某月某日的某一时间结束，表示规则在这段时间范围内生效。



多个**周期时间段**之间是**或的关系**，周期时间段之间**冲突**，那就这几个时间段**都生效**；

多个**绝对时间段**之间是**或的关系**，绝对时间段之间**冲突**，那就这几个时间段**都生效**；

**周期时间**段和**绝对时间**段之间是**与的关系**，周期时间段和绝对时间段之间**冲突**，配置的时间段**不生效**。



例如，在ACL 2001中引用了时间段“test”，“test”包含了三个生效时间段：

```
#  
time-range test 8:00 to 18:00 working-day 
time-range test 14:00 to 18:00 off-day 
time-range test from 00:00 2014/01/01 to 23:59 2014/12/31 
#  
acl number 2001                                                                 
 rule 5 permit time-range test 
```

- 第一个时间段，表示在周一到周五每天8:00到18:00生效，这是一个周期时间段。
- 第二个时间段，表示在周六、周日下午14:00到18:00生效，这是一个周期时间段。
- 第三个时间段，表示从**2014年1月1日00:00**起到**2014年12月31日23:59**生效，这是一个绝对时间段。

时间段“test”最终描述的时间范围为：2014年的周一到周五每天8:00到18:00以及周六和周日下午14:00到18:00。



如果第三个时间配置为**2014年1月1日19:00**起到**2014年1月1日21:00**，则时间段“test”无效。

当第三个时间段配置为“from 19:00 2014/01/01 to 21:00 2014/01/01”时，它仅指定了一个非常具体的绝对时间段，即2014年1月1日的19:00到21:00。这个时间段与前两个周期时间段（工作日的8:00到18:00，周末的14:00到18:00）在时间上并不重叠。

第一个和第二个周期时间段仍然保持其自身的有效性，只是它们与特定的绝对时间段结合时，无法找到共同的生效时间，从而在整体上看起来像是“失效”了。



### IP承载的协议类型

格式：*protocol-number* | **icmp** | **tcp** | **udp** | **gre** | **igmp** | **ip** | **ipinip** | **ospf**

高级ACL支持基于协议类型过滤报文，常用的协议类型如下表所示：

| 协议类型 | 协议编号 |
| -------- | -------- |
| ICMP     | 1        |
| TCP      | 6        |
| UDP      | 17       |
| GRE      | 47       |
| IGMP     | 2        |
| IPinIP   | 4        |
| OSPF     | 89       |

**IP**表示任何IP层协议。协议号的取值可以是1～255。

示例：

```
rule deny ip //表示拒绝IP报文通过
```



### 源/目的IP地址及其通配符掩码

将IP地址设置为过滤目标时，需要在IP地址字段后面同时指定通配符掩码，用来IP地址字段共同确定一个地址范围。

IP地址通配符掩码与IP地址的反向子网掩码类似，也是一个32比特位的数字字符串，用于指示IP地址中的哪些位将被检查。

各比特位中，“0”表示“检查相应的位”，“1”表示“不检查相应的位”。IP地址子网掩码中的“0”和“1”要求必须连续，而通配符掩码中的“0”和“1”可以不连续。



通配符掩码可以为0，相当于0.0.0.0，表示源/目的地址为主机地址；

可以为255.255.255.255，表示任意IP地址，相当于指定**any**参数。



举一个IP地址通配符掩码的示例，当希望来自192.168.1.0/24网段的所有IP报文都能够通过，可以配置如下规则：

```
rule 5 permit ip source 192.168.1.0 0.0.0.255
```



允许源IP为192.168.10.0/24且目标IP为192.168.20.0/24的数据包通过：

```
rule permit ip source 192.168.10.0 0.0.0.255 destination 192.168.20.0 0.0.0.255
```



#### 通配符掩码示例

| 项目           | 十进制等价值                     | 二进制等价值                                                 |
| -------------- | -------------------------------- | ------------------------------------------------------------ |
| 参照地址       | 192.168.1.0                      | 11000000.10101000.00000001.00000000                          |
| 通配符掩码     | 0.0.0.255                        | 00000000.00000000.00000000.**11111111**                      |
| 确定的地址范围 | 192.168.1.**表示0～255之间的整数 | 11000000.10101000.00000001.**xxxxxxxx**x既可以是0，也可以是1 |



####  IP地址与通配符掩码共同确定的地址范围

| IP地址     | IP地址通配符掩码                        | 确定的地址范围                                               |
| ---------- | --------------------------------------- | ------------------------------------------------------------ |
| 0.0.0.0    | 255.255.255.255                         | 任意IP地址                                                   |
| 172.18.0.0 | 0.0.255.255                             | 172.18.0.0/16网段的IP地址                                    |
| 172.18.5.2 | 0.0.0.0                                 | 仅172.18.5.2这一个主机地址                                   |
| 172.18.8.0 | 0.0.0.7                                 | 172.18.8.0/29网段的IP地址                                    |
| 172.18.8.8 | 0.0.0.7                                 | 172.18.8.8/29网段的IP地址                                    |
| 10.1.2.0   | 0.0.254.255（通配符掩码中的1和0不连续） | 10.1.0.0/24～10.1.254.0/24网段之间且第三个字节为偶数的IP地址，如10.1.0.0/24、10.1.2.0/24、10.1.4.0/24、10.1.6.0/24等。 |



### 源/目的MAC地址及其通配符掩码

注：仅二层ACL支持基于源/目的MAC地址过滤报文。

源MAC地址及其通配符掩码格式：**source-mac** *source-mac-address* [ *source-mac-mask* ]

目的地址及其通配符掩码格式：**destination-mac** *dest-mac-address* [ *dest-mac-mask* ]



将MAC地址定义为规则匹配项时，可以在MAC地址字段后面同时指定通配符掩码，用来与MAC地址字段共同确定一个地址范围。

MAC地址通配符掩码各比特位中，1表示“检查相应的位”，0表示“不检查相应的位”。如果不指定通配符掩码，则默认掩码为ffff-ffff-ffff，表示检查MAC地址的每一位。



MAC地址与通配符掩码共同确定的地址范围

| MAC地址        | MAC地址通配符掩码 | 确定的地址范围                 |
| -------------- | ----------------- | ------------------------------ |
| 00e0-fc01-0101 | 0000-0000-0000    | 任意MAC地址                    |
| 00e0-fc01-0101 | ffff-ffff-ffff    | 仅00e0-fc01-0101这一个MAC地址  |
| 00e0-fc01-0101 | ffff-ffff-0000    | 00e0-fc01-0000～00e0-fc01-ffff |



### VLAN编号及其掩码

注：二层ACL支持基于外层VLAN或内层VLAN编号过滤报文。

外层VLAN及其掩码格式：**vlan-id** *vlan-id* [ *vlan-id-mask* ]

内层VLAN及其掩码格式：**cvlan-id** *cvlan-id* [ *cvlan-id-mask* ]



将VLAN编号定义为规则匹配项时，可以在VLAN编号字段后面同时指定VLAN掩码，用来与VLAN编号字段共同确定一个VLAN范围。

VLAN掩码的格式是十六进制形式，取值范围是0x0～0xFFF。如果不指定VLAN掩码，则默认掩码为0xFFF，表示检查VLAN编号的每一位。



VLAN编号及其掩码共同确定的VLAN范围

| VLAN编号 | VLAN掩码 | 确定的VLAN范围  |
| -------- | -------- | --------------- |
| 10       | 0x000    | 任意VLAN        |
| 10       | 0xFFF    | 仅VLAN 10       |
| 10       | 0xFF0    | VLAN 1～VLAN 15 |



### TCP/UDP端口号

源端口号格式：**source-port** { **eq** *port* | **gt** *port* | **lt** *port* | **range** *port-start* *port-end* }

目的端口号格式：**destination-port** { **eq** *port* | **gt** *port* | **lt** *port* | **range** *port-start* *port-end* }

- **eq** *port*：指定等于源/目的端口。
- **gt** *port*：指定大于源/目的端口。
- **lt** *port*：指定小于源/目的端口。
- **range** *port-start* *port-end*：指定源/目的端口的范围。*port-start*是端口范围的起始，*port-end*是端口范围的结束。



TCP/UDP端口号可以使用数字表示，也可以用字符串（助记符）表示。例如，**rule deny tcp destination-port eq 80**，可以用**rule deny tcp destination-port eq www**替代。



### TCP标志信息

在高级ACL中，当协议类型指定为TCP时，设备支持基于TCP标志信息过滤报文。

格式：**tcp-flag** { **ack** | **established** | **fin** | **psh** | **rst** | **syn** | **urg** }*



TCP报文头有6个标志位：ack (acknowledge)、fin (finish)、psh (push)、rst (reset)、syn (synchronize)和urg (urgent)。

TCP标志信息中的**established**，表示标志位为ACK(010000)或RST(000100)。



指定**tcp-flag**的ACL规则可以用来实现单向访问控制。假设，要求192.168.1.0/24网段用户可以主动访问192.168.2.0/24网段用户，但反过来192.168.2.0/24网段用户不能主动访问192.168.1.0/24。



由TCP建立连接和关闭连接的过程可知，只有在TCP中间连接过程的报文才会ACK=1或者RST=1。根据这个特点，配置如下两种ACL规则，允许TCP中间连接过程的报文通过，拒绝其他TCP报文通过，就可以限制192.168.2.0/24网段主动发起的TCP连接。

- 类型一：配置指定**ack**和**rst**参数的ACL规则

    ```
    rule 5 permit tcp source 192.168.2.0 0.0.0.255 tcp-flag ack  //允许ACK=1的TCP报文通过       
    rule 10 permit tcp source 192.168.2.0 0.0.0.255 tcp-flag rst   //允许RST=1的TCP报文通过
    rule 15 deny tcp source 192.168.2.0 0.0.0.255  //拒绝其他TCP报文通过
    ```

- 类型二：配置指定**established**参数的ACL规则

    ```
    rule permit tcp source 192.168.2.0 0.0.0.255 tcp-flag established  // established表示ACK=1或者RST=1，表示允许TCP中间连接过程的报文通过
    rule deny tcp source 192.168.2.0 0.0.0.255     //拒绝其他TCP报文通过
    ```



### IP分片信息

基本ACL和高级ACL支持基于IP分片信息过滤报文。

格式：**fragment**



**IP分片介绍**：

- IP分片除了首片报文外，还有后续分片报文，又叫做非首片分片报文。
- 仅首片分片报文携带四层信息（如TCP/UDP端口号等），后续分片报文均不携带。
- 网络设备收到分片报文后，会判断其是否是最后一个分片报文。
- 如果不是，则为其分配内存空间，以便于最后一个分片报文到达后完成重组。



黑客可以利用这一点，向接收方设备发起分片报文攻击，始终不向接收方发送最后一个分片报文。

为了解决这个问题，可以配置指定**fragment**匹配项的ACL规则来阻塞非首片分片报文，从而达到防范分片报文攻击的目的。



针对非分片报文、首片分片报文、非首片分片报文这三类报文，ACL的处理方式：

| 规则包含的匹配项                       | 非分片报文                                                   | 首片分片报文                                                 | 非首片分片报文                                               |
| -------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 三层信息（如源/目的IP地址）            | 三层信息匹配上，则返回匹配结果（permit/deny）；未匹配上，则转下一条规则进行匹配 | 三层信息匹配上，则返回匹配结果（permit/deny）；未匹配上，则转下一条规则进行匹配 | 三层信息匹配上，则返回匹配结果（permit/deny）；未匹配上，则转下一条规则进行匹配 |
| 三层信息 + 四层信息（如TCP/UDP端口号） | 三层和四层信息都匹配上，则返回匹配结果（permit/deny）；未匹配上，则转下一条规则进行匹配 | 三层和四层信息都匹配上，则返回匹配结果（permit/deny）；未匹配上，则转下一条规则进行匹配 | 不匹配，转下一条规则进行匹配                                 |
| 三层信息 + **fragment**                | 不匹配，转下一条规则进行匹配                                 | 不匹配，转下一条规则进行匹配                                 | 三层信息匹配上，则返回匹配结果（permit/deny）；未匹配上，则转下一条规则进行匹配 |



例如，ACL 3012中存在以下规则：

```
#                                                                               
acl number 3012                                                                 
 rule 5 deny tcp destination 192.168.2.2 0 fragment                             
 rule 10 permit tcp destination 192.168.2.2 0 destination-port eq www           
 rule 15 deny ip                                                                
#                      
```

对于目的IP地址是192.168.2.2的TCP报文：

- 该报文是非分片报文或首片分片报文时：如果该报文的目的端口号是80（www对应的端口号是80），则报文与rule 10匹配，报文被允许通过；如果该报文的目的端口号不是80，则报文与rule 15匹配，报文被拒绝通过。
- 该报文是非首片分片报文时：该报文与rule 5匹配，报文被拒绝通过。
