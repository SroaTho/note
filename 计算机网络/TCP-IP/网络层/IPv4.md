# IPv4

![IPv4 数据报头](images/IPv4.assets/Screenshot-(359).png)

**VERSION(版本):** IP协议的版本（4位），IPv4的版本为4。

**HLEN(头部长度):** IP头部长度（4位），表示头部中32位字的数量。此字段的最小值为5，最大值为15。

IP头部的长度是以32位（也就是4字节）为单位来计量的，IP头部长度（HLEN）表示IP头部占用了多少个4字节（32位）。

此字段的最小值为5时，IP头部的最小长度是5*32位（160位/20字节）。IP头部至少要包含5个32位字的信息。

此字段的最大值为15，IP头部的最大长度是15*32位（480位/60字节）。IP头部最多可以包含15个32位字的信息。

**Type of service(服务类型):** 低延迟，高吞吐量，可靠性（8位）。

**Total Length(总长度):** 头部+数据的长度（16位），最小值为20字节，最大值为65,535字节。

**Identification(标识):** 用于识别单个IP数据报片段组的唯一数据包ID（16位）。

**Flags(标志):** 每个标志占用1位，共3个标志：保留位（必须为零），不分片标志，更多分片标志。

不分片标志：如果设置为1，这意味着这个数据包不能被分片。如果这个数据包的大小超过了中途路由器的最大传输单元（MTU），那么中途路由器会丢弃这个数据包，并生成一个"需要进行分片但设置了不分片位"的ICMP错误消息，并将这个消息发送回原始数据包的发送者。这个ICMP错误消息包含了导致错误的IP头部以及数据部分的前8个字节。发送者能判断哪个数据包出现了问题，并采取相应的措施。

更多分片标志表示：是否还有更多的片段需要发送。当一个IP数据报被分片时，除了最后一个片段外，其余的片段都会设置这个"更多片段标志"。

**Fragment Offset(片段偏移):** 表示分片数据包在原始数据包中字节数位置。以8字节的数量指定，最大值为65,528字节。

字段的值是以8字节为单位来计量的。如果片段偏移字段的值为1，表示这个分片是在原始数据报的第8个字节之后开始的。

片段偏移字段是一个13位的字段，片段的最大值为8191（即2的13次方减1）。片段偏移是以8字节为单位来计量的，所以最大的偏移量就是8191*8=65,528字节。

**Time to live(生存周期):** 数据报的生命周期（8位），它通过限制数据包在传送到目的地之前所采取的跳数，防止数据报在网络中循环。

**Protocol(协议):** 将数据传递给哪个协议的名称（8位）。

**Header Checksum(头部校验和):** 用于检查数据报头中错误的16位头部校验和。

**Source IP address(源IP地址):** 发送者的32位IP地址。

**Destination IP address(目标IP地址):** 接收者的32位IP地址。

**Option(选项):** 可选信息，如源路由，记录路由。网络管理员用它来检查路径是否正常工作。





# IPv4分片

**为什么需要IPv4数据报文分片？** 不同的网络可能有不同的最大传输单元（MTU），例如由于LAN技术的差异。当一个网络想要向MTU较小的网络传输数据报文时，路径上的路由器可能会对数据报文进行分片和重组。

在IPv4中，当一个数据包大于它需要经过的网络链路的最大传输单元（MTU）时，它会被分片成更小的数据包。这些分片中的每一个都包含原始数据包的一部分，以及标识**分片在原始数据包中的位置**和**如何将分片重新组装成原始的IP数据报**的**额外信息**。



分片可能会在网络中引起延迟和其他问题。以下是一些可能发生的情况：

- 增加的处理开销：分片需要网络设备提供额外的处理和内存资源。这可能会增加处理开销，并在网络中引入额外的延迟。 
- 数据包丢失的可能性增加：由于每个分片都是单独传输的，所以在传输过程中数据包丢失或损坏的可能性增加。如果任何一个分片丢失或损坏，整个数据包必须重新传输，这可能会引入额外的延迟并增加网络拥塞。 
- 重组延迟：接收分片的设备必须在处理之前重新组装原始数据包。如果接收所有分片存在延迟，或者分片到达的顺序不正确，这个过程可能会引入额外的延迟。 



**如何进行分片？** 当路由器接收到一个数据包时，会检查目标地址并确定MTU。如果数据包的大小大于MTU，并且头部中的“不分片（DF）”位设置为0，那么数据包就会被分片成若干部分并逐一发送。每个分片的最大大小是MTU减去IP头部大小（最小20字节，最大60字节）。



总长度字段被改为分片的大小。 除最后一个分片外，所有分片的数据包都设置了更多分片位（MF位）。

根据正在设置的分片数量和MTU，设置片段偏移字段。 重新计算头部校验和。 

例如：对于一个4000字节的数据包和1500字节的MTU，我们有3980字节的实际数据需要传输，而1480字节是允许发送的最大数据大小。所以，会有3个分片：

第一个分片，数据大小=1480字节，偏移=0，MF标志=1

第二个分片，数据大小=1480字节，偏移=185（1480/8），MF标志=1

第三个分片，数据大小=1020字节，偏移=370（2960/8），MF标志=0 



![image-20231223221247601](images/IPv4.assets/image-20231223221247601.png)

二次分片，假设：R1将原始数据包分片成三个分片数据包后，按照一定的路由规则，将第一个和第三个分片发送给R2，将第二个分片发送给R3。R2收到第一个和第三个分片数据包后，R2到R4的MTU为1500，可以承受分片数据包大小，无需二次分片可以直接发送。R3收到第二个分片数据包后，由于R3到R4的MTU为500，不能承受分片数据包的大小，需要二次分片。

原始第二个分片数据包：第二个分片，数据大小=1480字节，偏移=185（1480/8），MF标志=1

现在有1480字节的实际数据需要传输，MTU为500，而480字节是允许发送的最大数据大小。所以，二次分片会有4个分片：

第一个分片，数据大小=480字节，偏移=185（1480/8，原始第二个分片数据包偏移地址保持不变），MF标志=1

第二个分片，数据大小=480字节，偏移=245（ (1480/8) + (480/8) |185 + 60），MF标志=1

第三个分片，数据大小=480字节，偏移=305，MF标志=1

第四个分片，数据大小=40字节，  偏移=310，MF标志=1（注意：这是原始第二个分片的二次分片，原始第二个分片后还有分片，所以此处标志为1）



R3将原始第二个数据包二次分片后，将这四个分片发送给R4。R4从R2接收到2个分片，从R3接收到4个分片，R4共接收到6个分片，如下：

第一个分片，数据大小=1480字节，偏移=0，    MF标志=1

第二个分片，数据大小=480字节，  偏移=185，MF标志=1

第三个分片，数据大小=480字节，  偏移=245，MF标志=1

第四个分片，数据大小=480字节，  偏移=305，MF标志=1

第五个分片，数据大小=40字节，    偏移=365，MF标志=1

第六个分片，数据大小=1020字节，偏移=370，MF标志=0 